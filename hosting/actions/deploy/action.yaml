name: Deploy Hosting Worker
description: Deploy the vibes.diy hosting worker to Cloudflare

inputs:
  environment:
    description: "Environment to deploy to (dev, production, preview)"
    required: true
    default: "production"
  worker_name:
    description: "Name of the worker to deploy to"
    required: false
    default: ""
  CLOUDFLARE_API_TOKEN:
    description: "Cloudflare API token for deployment"
    required: true
  CLOUDFLARE_ACCOUNT_ID:
    description: "Cloudflare account ID"
    required: true
  SERVER_OPENROUTER_API_KEY:
    description: "OpenRouter API key for AI chat completions"
    required: true
  OPENAI_API_KEY:
    description: "OpenAI API key for image generation and chat"
    required: true
  ANTHROPIC_API_KEY:
    description: "Anthropic API key for Claude chat (optional)"
    required: false
  CLERK_SECRET_KEY:
    description: "Clerk secret key for backend authentication"
    required: true
  CLERK_PUBLISHABLE_KEY:
    description: "Clerk publishable key for frontend authentication"
    required: true
  DISCORD_WEBHOOK_URL:
    description: "Discord webhook URL for notifications (optional)"
    required: false
  BLUESKY_APP_PASSWORD:
    description: "Bluesky app password for social posting (optional)"
    required: false

runs:
  using: composite
  steps:
    - name: Install dependencies
      shell: bash
      run: pnpm install

    - name: Run hosting CI checks
      shell: bash
      run: |
        echo "üèóÔ∏è Running comprehensive hosting CI pipeline..."
        pnpm hosting:check

    - name: Create queue if needed
      shell: bash
      run: |
        cd hosting/pkg
        echo "üìã Ensuring queue exists..."

        # Create the queue if it doesn't exist (ignore error if it already exists)
        npx wrangler queues create publish-events-v2 || echo "‚ÑπÔ∏è Queue may already exist"

        echo "‚úÖ Queue setup complete"
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deploy to Cloudflare Workers
      shell: bash
      run: |
        cd hosting/pkg

        # Determine worker name and environment
        if [ -n "${{ inputs.worker_name }}" ]; then
          WORKER_NAME="${{ inputs.worker_name }}"
          ENV_FLAG="--env ${{ inputs.environment }}"
          echo "üöÄ Deploying ${WORKER_NAME} worker (environment: ${{ inputs.environment }})..."
          npx wrangler deploy --name ${WORKER_NAME} ${ENV_FLAG}
        else
          WORKER_NAME="vibes-hosting-v2"
          echo "üöÄ Deploying ${WORKER_NAME} worker (default production)..."
          npx wrangler deploy --env=""
        fi

        echo "‚úÖ Worker deployed successfully"

        # Set output for worker URL
        echo "worker_url=https://${WORKER_NAME}.jchris.workers.dev" >> $GITHUB_OUTPUT
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.CLOUDFLARE_ACCOUNT_ID }}

    - name: Configure worker secrets
      shell: bash
      run: |
        cd hosting/pkg

        # Set flags to match deployment configuration
        if [ -n "${{ inputs.worker_name }}" ]; then
          WRANGLER_FLAGS="--name ${{ inputs.worker_name }} --env ${{ inputs.environment }}"
        else
          WRANGLER_FLAGS=""
        fi

        echo "üîê Setting required API secrets..."

        # Required AI API keys
        echo "${{ inputs.SERVER_OPENROUTER_API_KEY }}" | npx wrangler secret put SERVER_OPENROUTER_API_KEY $WRANGLER_FLAGS
        echo "${{ inputs.OPENAI_API_KEY }}" | npx wrangler secret put OPENAI_API_KEY $WRANGLER_FLAGS

        # Required Clerk keys
        echo "${{ inputs.CLERK_SECRET_KEY }}" | npx wrangler secret put CLERK_SECRET_KEY $WRANGLER_FLAGS
        echo "${{ inputs.CLERK_PUBLISHABLE_KEY }}" | npx wrangler secret put CLERK_PUBLISHABLE_KEY $WRANGLER_FLAGS

        echo "‚úÖ Required secrets configured"

        # Optional Anthropic key
        if [ -n "${{ inputs.ANTHROPIC_API_KEY }}" ]; then
          echo "üîê Setting Anthropic API key..."
          echo "${{ inputs.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY $WRANGLER_FLAGS
        else
          echo "‚ÑπÔ∏è  Anthropic API key not provided (optional - Claude endpoints will be disabled)"
        fi

        # Optional secrets
        if [ -n "${{ inputs.DISCORD_WEBHOOK_URL }}" ]; then
          echo "üîê Setting Discord webhook..."
          echo "${{ inputs.DISCORD_WEBHOOK_URL }}" | npx wrangler secret put DISCORD_WEBHOOK_URL $WRANGLER_FLAGS
        else
          echo "‚ÑπÔ∏è  Discord webhook not provided (optional)"
        fi

        if [ -n "${{ inputs.BLUESKY_APP_PASSWORD }}" ]; then
          echo "üîê Setting Bluesky credentials..."
          echo "${{ inputs.BLUESKY_APP_PASSWORD }}" | npx wrangler secret put BLUESKY_APP_PASSWORD $WRANGLER_FLAGS
        else
          echo "‚ÑπÔ∏è  Bluesky password not provided (optional)"
        fi

        echo "‚úÖ All secrets configured successfully"
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.CLOUDFLARE_ACCOUNT_ID }}

    - name: Upload KV assets
      shell: bash
      run: |
        cd hosting/pkg

        echo "üì¶ Uploading static assets to KV store..."

        # Upload favicon and babel assets
        pnpm kv:put-svg:remote || echo "‚ö†Ô∏è  SVG upload failed, continuing..."
        pnpm kv:put-ico:remote || echo "‚ö†Ô∏è  ICO upload failed, continuing..."
        pnpm kv:put-babel:remote || echo "‚ö†Ô∏è  Babel upload failed, continuing..."

        echo "‚úÖ Asset upload completed"
      env:
        CLOUDFLARE_API_TOKEN: ${{ inputs.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deployment summary
      shell: bash
      run: |
        echo ""
        echo "üéâ Deployment Summary"
        echo "===================="
        echo "‚úÖ Worker: vibes-hosting-v2"
        echo "üåê Worker URL: https://vibes-hosting-v2.workers.dev"
        echo ""
        echo "üîÑ Production Deployment - Next Steps:"
        echo "1. Test the worker URL above"
        echo "2. Update domain routes in Cloudflare Dashboard:"
        echo "   - vibesdiy.work (test first)"
        echo "   - vibecode.garden"
        echo "   - vibes-diy-api.com" 
        echo "   - vibesdiy.app (production last)"
        echo "3. Monitor error rates and performance"
        echo "4. Keep old worker as backup for 30 days"
