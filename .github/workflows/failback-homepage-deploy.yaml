name: Deploy Failback Homepage

on:
  # Production deployment on main only
  push:
    paths:
      - "vibes.diy/failback-homepage/**/*"
    branches:
      - main

  # Manual trigger for controlled deployments
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - preview

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'push' && 'production' || github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup runtime environment
        uses: ./actions/runtime

      - name: Install failback-homepage dependencies
        run: |
          cd vibes.diy/failback-homepage
          pnpm install

      - name: Build failback-homepage
        run: |
          cd vibes.diy/failback-homepage
          pnpm build

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd vibes.diy/failback-homepage

          # Determine environment for deployment
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "üöÄ Deploying to production..."
            npx wrangler deploy
          else
            echo "üöÄ Deploying to preview environment..."
            npx wrangler deploy --env preview
          fi

          echo "‚úÖ Deployment complete!"

      - name: Deployment summary
        run: |
          echo ""
          echo "üéâ Failback Homepage Deployment Summary"
          echo "========================================"
          echo "‚úÖ Build completed successfully"
          echo "‚úÖ Deployed to Cloudflare Workers"
          echo ""
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "üåê Production: Check Cloudflare dashboard for worker URL"
          else
            echo "üåê Preview: Check Cloudflare dashboard for preview worker URL"
          fi
          echo ""
