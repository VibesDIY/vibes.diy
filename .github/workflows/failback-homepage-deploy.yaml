name: Deploy Failback Homepage

on:
  # Production deployment on main only
  push:
    paths:
      - "vibes.diy/failback-homepage/**/*"
    branches:
      - main

  # Manual trigger for controlled deployments
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - preview

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'push' && 'production' || github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup runtime environment
        uses: ./actions/runtime

      - name: Install failback-homepage dependencies
        run: |
          cd vibes.diy/failback-homepage
          pnpm install

      - name: Build failback-homepage
        run: |
          cd vibes.diy/failback-homepage
          pnpm build

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd vibes.diy/failback-homepage

          # Determine project name based on environment
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            PROJECT_NAME="failback-homepage"
            echo "ğŸš€ Deploying to production..."
          else
            PROJECT_NAME="failback-homepage-preview"
            echo "ğŸš€ Deploying to preview..."
          fi

          # Deploy to Cloudflare Pages
          npx wrangler pages deploy dist --project-name=${PROJECT_NAME}

          echo "âœ… Deployment complete!"
          echo "ğŸŒ Site URL: https://${PROJECT_NAME}.pages.dev"

      - name: Deployment summary
        run: |
          echo ""
          echo "ğŸ‰ Failback Homepage Deployment Summary"
          echo "========================================"
          echo "âœ… Build completed successfully"
          echo "âœ… Deployed to Cloudflare Pages"
          echo ""
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ğŸŒ Production URL: https://failback-homepage.pages.dev"
          else
            echo "ğŸŒ Preview URL: https://failback-homepage-preview.pages.dev"
          fi
          echo ""
