name: Cleanup Vibesbox PR Preview

on:
  pull_request:
    types: [closed]
    paths:
      - "vibesbox/**/*"
      - ".github/workflows/vibesbox-pr-preview.yaml"

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Allow posting comments

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup runtime environment
        uses: ./actions/runtime

      - name: Set PR number
        id: pr
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          WORKER_NAME="vibesbox-pr-${PR_NUMBER}"
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "worker_name=${WORKER_NAME}" >> $GITHUB_OUTPUT

      - name: Delete preview worker
        id: delete
        run: |
          cd vibesbox/pkg
          echo "üóëÔ∏è  Deleting preview worker for PR #${{ steps.pr.outputs.number }}..."
          echo "üì¶ Worker name: ${{ steps.pr.outputs.worker_name }}"

          # Delete the worker
          npx wrangler delete ${{ steps.pr.outputs.worker_name }} --force || echo "Worker may not exist or already deleted"

          echo "‚úÖ Cleanup completed"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # TODO: Using test Clerk key - upgrade to production key before merging to main
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const workerName = '${{ steps.pr.outputs.worker_name }}';

            const commentBody = `## üßπ Vibesbox Preview Cleanup

            The preview deployment for this PR has been deleted.

            **Worker:** \`${workerName}\`
            **Status:** Cleaned up successfully

            ---
            <sub>Preview resources have been removed from Cloudflare Workers</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody,
            });

      - name: Cleanup summary
        run: |
          echo ""
          echo "üßπ PR Preview Cleanup Summary"
          echo "=============================="
          echo "‚úÖ PR: #${{ steps.pr.outputs.number }}"
          echo "üì¶ Worker deleted: ${{ steps.pr.outputs.worker_name }}"
          echo ""
          echo "üìù Preview resources have been cleaned up"
          echo ""
