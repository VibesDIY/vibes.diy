name: Sync Secrets to Preview Environment

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "sync" to confirm secret synchronization'
        required: true

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    environment: production # Read from production
    permissions:
      contents: read
      secrets: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "sync" ]; then
            echo "‚ùå Confirmation failed. Please type 'sync' to proceed."
            exit 1
          fi

      - name: Sync secrets to preview environment
        run: |
          echo "üîÑ Syncing secrets from production to preview environment..."

          # Sync infrastructure secrets (same for all envs)
          gh secret set CLOUDFLARE_API_TOKEN --env preview --body "${{ secrets.CLOUDFLARE_API_TOKEN }}"
          gh secret set CLOUDFLARE_ACCOUNT_ID --env preview --body "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"

          # Sync AI API keys (same for all envs)
          gh secret set SERVER_OPENROUTER_API_KEY --env preview --body "${{ secrets.SERVER_OPENROUTER_API_KEY }}"
          gh secret set OPENAI_API_KEY --env preview --body "${{ secrets.OPENAI_API_KEY }}"
          gh secret set ANTHROPIC_API_KEY --env preview --body "${{ secrets.ANTHROPIC_API_KEY }}"

          # Sync optional notification secrets
          gh secret set DISCORD_WEBHOOK_URL --env preview --body "${{ secrets.DISCORD_WEBHOOK_URL }}"
          gh secret set BLUESKY_APP_PASSWORD --env preview --body "${{ secrets.BLUESKY_APP_PASSWORD }}"

          # Use TEST Clerk key for preview environment
          gh secret set CLERK_SECRET_KEY --env preview --body "${{ secrets.CLERK_SECRET_KEY_TEST }}"

          echo "‚úÖ All secrets synced to preview environment"
          echo ""
          echo "Preview environment now has:"
          echo "  - CLOUDFLARE_API_TOKEN (copied from production)"
          echo "  - CLOUDFLARE_ACCOUNT_ID (copied from production)"
          echo "  - SERVER_OPENROUTER_API_KEY (copied from production)"
          echo "  - OPENAI_API_KEY (copied from production)"
          echo "  - ANTHROPIC_API_KEY (copied from production)"
          echo "  - DISCORD_WEBHOOK_URL (copied from production)"
          echo "  - BLUESKY_APP_PASSWORD (copied from production)"
          echo "  - CLERK_SECRET_KEY (using TEST key from production)"
        env:
          GH_TOKEN: ${{ github.token }}
