<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Generated App</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }
      #container {
        width: 100%;
        height: 100vh;
      }
    </style>
    <script>
      // Screenshot functionality
      function captureScreenshot() {
        html2canvas(document.body).then(canvas => {
          const dataURI = canvas.toDataURL();
          window.parent.postMessage({ type: 'screenshot', data: dataURI }, '*');
        });
      }

      function pageIsLoaded() {
        window.parent.postMessage({ type: 'preview-ready' }, '*');
        setTimeout(captureScreenshot, 100);
      }

      // For rapid updates (optional)
      let currentApp = null;
      function updateAppComponent(code) {
        try {
          // Evaluate new component code
          eval(code);
          
          // If we implement rapid updates, we'll need to re-render here
          if (currentApp && window.ReactDOM) {
            // Re-render with new component
          }
          
          return true;
        } catch (error) {
          console.error('Failed to update component:', error);
          return false;
        }
      }

      // Event listeners
      window.addEventListener('message', function(event) {        
        if (event.data) {
          if (event.data.type === 'command') {
            if (event.data.command === 'capture-screenshot') {
              captureScreenshot();
            }
          } else if (event.data.type === 'update-component') {
            // For rapid updates (optional)
            updateAppComponent(event.data.code);
          } else if (event.data.type === 'callai-api-key' && event.data.key) {
            window.CALLAI_API_KEY = event.data.key;
          }
        }
      });

      window.addEventListener('DOMContentLoaded', function() {
        pageIsLoaded();
      });
    </script>
  </head>
  <body>
    <div id="container"></div>
    <script>
      window.CALLAI_API_KEY = '{{API_KEY}}';
    </script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.0.0",
          "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
          "use-fireproof": "https://esm.sh/use-fireproof@0.20.0-dev-preview-57",
          "call-ai": "https://esm.sh/call-ai@0.5.0"
        }
      }
    </script>
    <script type="text/babel" data-type="module">
      import ReactDOMClient from 'react-dom/client';
      {{APP_CODE}}

      const rootElement = document.getElementById('container');
      ReactDOMClient.createRoot(rootElement).render(<App />);
    </script>
  </body>
</html>
